<!-- HTML header for doxygen 1.8.10-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<title>Intel&reg; Enhanced Privacy ID SDK: Considerations for TPM</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="epidstyle.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"><a 
                            onclick="storeLink('index.html')"
                            id="projectlink" 
                            class="index.html" 
                            href="index.html">Intel&reg; Enhanced Privacy ID SDK</a>
&#160;<span id="projectnumber">8.0.0</span>
</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('_tpm_considerations.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Considerations for TPM </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#TPM_compatibility">Compatibility</a></li>
<li class="level1"><a href="#TpmConsiderations_Manufacturers">Considerations for TPM Manufacturers</a><ul><li class="level2"><a href="#TPM_provisioning">Provisioning TPM with Intel&reg; EPID Key Material</a></li>
<li class="level2"><a href="#TpmConsiderations_Mapping">Mapping TPM Commands to Intel&reg; EPID APIs</a></li>
</ul>
</li>
<li class="level1"><a href="#TpmConsiderations_Applications">Considerations for TPM Applications</a></li>
<li class="level1"><a href="#TpmConsiderations_Architecture">SDK Member Architecture</a></li>
<li class="level1"><a href="#TpmConsiderations_Building">Building the SDK to Take Advantage of TPM</a><ul><li class="level2"><a href="#TpmConsiderations_Prereqs">Installing Prerequisites</a></li>
<li class="level2"><a href="#TpmConsiderations_BuildingTpmMode">Building the SDK in TPM Mode</a></li>
<li class="level2"><a href="#TpmConsiderations_Signing">Intel&reg; EPID Signing and Verification with a TPM</a></li>
</ul>
</li>
<li class="level1"><a href="#TpmConsiderations_Notes">Implementation Notes</a><ul><li class="level2"><a href="#TpmConsiderations_NVStorage">NV Storage Specification</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>Intel&reg; EPID is compatible with TPM (Trusted Platform Modules) and is designed to take advantage of the security features of TPM. This section describes integrating a TPM device and Intel&reg; EPID functionality.</p>
<p>Intel&reg; EPID is a technology for securely and anonymously identifying a device, and TPM is a technology for protecting secrets on a device. Therefore it is desirable to protect the most secret part of the member private key on an Intel&reg; EPID TPM device.</p>
<h1><a class="anchor" id="TPM_compatibility"></a>
Compatibility</h1>
<p>The SDK is compatible with the Trusted Computing Group's TPM 2.0 specification Level 00, Revision 01.38</p>
<h1><a class="anchor" id="TpmConsiderations_Manufacturers"></a>
Considerations for TPM Manufacturers</h1>
<p>This section explains what manufacturers have to do with the SDK in order to have their TPMs recognized to a service provider:</p>
<ul>
<li>Provisioning TPM devices with crypto secrets</li>
<li>Adapting SDK code to specific TSS functionality</li>
</ul>
<p>This SDK was tested on the IBM TPM and TSS (Trusted Computing Group Software <a class="el" href="struct_stack.html" title="Internal representation of a Stack. ">Stack</a>). Device manufacturers should replace specific items with their own TPM functionality.</p>
<h2><a class="anchor" id="TPM_provisioning"></a>
Provisioning TPM with Intel® EPID Key Material</h2>
<p>For TPM use with Intel&reg; EPID, members and verifiers need to be provisioned with crypto material to enable security function.</p>
<p>In order to ensure that the <code>f</code> value only exists in the volatile memory of the TPM, TPM manufacturers need to provision the TPM with an EPS (Endorsement Primary Seed), from which the <code>f</code> value of the member private key is derived.</p>
<p>Typically, bulk provisioning is more efficient than dynamic provisioning in a manufacturing environment. However, bulk provisioning is not viable for TPM devices for the following reasons:</p>
<ul>
<li>In bulk provisioning, the issuer provides <code>f</code> as part of each member private key, but it is intentionally difficult to derive EPS from <code>f</code>.</li>
<li>The issuer cannot provide EPS to manufacturers because the translation from EPS to <code>f</code> is dependent upon an implementation specific, deterministic random number generator.</li>
</ul>
<p>Therefore, in order to provision the TPM with EPS, Intel supports a variation on typical <a class="el" href="_provisioning.html#Provisioning_JoinProvisioning">dynamic provisioning</a> in which manufacturers provide their own EPS.</p>
<p>In this variation on dynamic provisioning, which we call <b>bulk-join</b>, some steps are performed in bulk and credentials for many devices can be generated at the same time. This process allows TPM devices to be provisioned during manufacturing.</p>
<p>For bulk-join, TPM device manufacturers need to do the following:</p>
<ol type="1">
<li><b>Generate a set of EPS</b>, because EPS are the seeds from which the <code>f</code> values of the member private keys are generated.</li>
<li><b>Derive a set of <code>f</code> values</b> from the EPS values.</li>
<li><b>Request a set of nonces from the issuer</b> which will be used to generate join requests.</li>
<li><b>Generate a set of join requests</b> using the <code>f</code> values and nonces and send them to the issuer. The issuer will respond to the bulk join requests by sending membership credentials to the manufacturer in bulk. The SDK includes the <a class="el" href="_commandline_tools.html#Joinreq">Joinreq</a> command-line tool to automate this step.</li>
<li><b>Provision the membership credentials in silicon,</b> mapping each membership credential to the corresponding EPS value.</li>
</ol>
<p>The following graphic shows how the issuer, manufacturer, TPM, and member interact during the time of key generation, device manufacturing, and signing:</p>
<div class="image">
<img src="uml_sequence.png" alt="uml_sequence.png"/>
</div>
<h2><a class="anchor" id="TpmConsiderations_Mapping"></a>
Mapping TPM Commands to Intel® EPID APIs</h2>
<p>The <code>tpm2</code> module in the <code>member</code> section of the API reference contains internal functions that map to TPM commands. This code is provided as sample code for manufacturers who will use it to write their own implementation of Intel&reg; EPID APIs for TPM.</p>
<table class="doxtable">
<tr>
<th>Intel&reg; EPID Function </th><th>Corresponding TPM 2.0 Command  </th></tr>
<tr>
<td>Tpm2Commit </td><td>TPM2_Commit </td></tr>
<tr>
<td>Tpm2CreateContext </td><td>N/A </td></tr>
<tr>
<td>Tpm2DeleteContext </td><td>N/A </td></tr>
<tr>
<td>Tpm2GetRandom </td><td>TPM2_GetRandom </td></tr>
<tr>
<td>Tpm2LoadExternal </td><td>TPM2_LoadExternal </td></tr>
<tr>
<td>Tpm2NvDefineSpace </td><td>TPM2_NV_DefineSpace </td></tr>
<tr>
<td>Tpm2NvUndefineSpace </td><td>TPM2_NV_UndefineSpace </td></tr>
<tr>
<td>Tpm2NvWrite </td><td>TPM2_NV_Write </td></tr>
<tr>
<td>Tpm2NvRead </td><td>TPM2_NV_Read </td></tr>
<tr>
<td>Tpm2Sign </td><td>TPM2_Sign </td></tr>
</table>
<h1><a class="anchor" id="TpmConsiderations_Applications"></a>
Considerations for TPM Applications</h1>
<p>Unlike non-TPM device manufacturers, TPM manufacturers cannot use <a class="el" href="group___epid_member_module.html#ga07094399c1e040b95ae3e58a74e7c302" title="Provisions a member context from a private key. ">EpidProvisionKey</a>. TPMs are designed to protect secret values from access even by the programs that use them. Dynamic provisioning is specifically designed to allow this use case.</p>
<p>To get a TPM device running, TPM applications can use the following steps to join a group using a TPM protected secret:</p>
<ol type="1">
<li>Use <a class="el" href="group___epid_member_module.html#gab55c722b55284e873d97aaa373c7b614" title="Computes the size in bytes required for a member context. ">EpidMemberGetSize</a> and <a class="el" href="group___epid_member_module.html#gac9dc1d518ccab0f3bc84a7ccc3203dc3" title="Initializes a new member context. ">EpidMemberInit</a> to create a new member context. Those functions take the parameter <a class="el" href="struct_member_params.html" title="Implementation specific configuration parameters. ">MemberParams</a>. You will pass NULL to this struct instead of the <code>f</code> value, which indicates that <code>f</code> needs to be derived from the EPS within the TPM.</li>
<li>Use <a class="el" href="group___epid_member_module.html#ga8f4078b8c60975f9ee990b076d8e8e7d" title="Creates a request to join a group. ">EpidCreateJoinRequest</a> to generate join requests using the <code>f</code> derived from EPS within the TPM. Then send the join request to the issuer to request a membership credential.</li>
<li>After receiving the membership credential (A, x), use <a class="el" href="group___epid_member_module.html#ga788ebc9d1ba6153c637b762484ca1140" title="Provisions a member context from a membership credential. ">EpidProvisionCredential</a> to provision it into the non-volatile memory of the TPM device.</li>
</ol>
<p>After the TPM device is provisioned with <a class="el" href="group___epid_member_module.html#ga788ebc9d1ba6153c637b762484ca1140" title="Provisions a member context from a membership credential. ">EpidProvisionCredential</a>, the simplest way to get the device running is:</p>
<ol type="1">
<li><a class="el" href="group___epid_member_module.html#gab55c722b55284e873d97aaa373c7b614" title="Computes the size in bytes required for a member context. ">EpidMemberGetSize</a>,</li>
<li><a class="el" href="group___epid_member_module.html#gac9dc1d518ccab0f3bc84a7ccc3203dc3" title="Initializes a new member context. ">EpidMemberInit</a>,</li>
<li><a class="el" href="group___epid_member_module.html#gaa2c85b1f0ea17a11ac5d297b21aa30f6" title="Change member from setup state to normal operation. ">EpidMemberStartup</a>, and</li>
<li><a class="el" href="group___epid_member_module.html#ga74d1409a816cb52633564b793072da5f" title="Writes an Intel(R) EPID signature. ">EpidSign</a>.</li>
</ol>
<h1><a class="anchor" id="TpmConsiderations_Architecture"></a>
SDK Member Architecture</h1>
<p>In the SDK, the Tpm2 module exposes commands that can be mapped to real TSS commands.</p>
<div class="image">
<img src="member_host.png" alt="member_host.png"/>
</div>
<p>The <b>Member Host</b> (<code>member/split/src</code>) implements Intel&reg; EPID signing in terms of TPM2 commands.</p>
<p>The <b>TPM module</b> (<code>member/split/tpm2</code>) implements TPM2 commands.</p>
<p>There are two implementations of TPM functionality:</p>
<ul>
<li><b>IBM TSS dispatcher implementation</b> (<code>member/split/tpm2/ibm_tss</code>), which calls the IBM TSS, which calls the IBM TPM simulator (in this implementation). It is invoked when building in TPM mode.</li>
<li><b>TPM SDK software implementation</b> (<code>member/split/tpm2/builtin</code>) implements sufficient TPM functionality for Intel&reg; EPID. It is invoked when building in non-TPM mode.</li>
</ul>
<h1><a class="anchor" id="TpmConsiderations_Building"></a>
Building the SDK to Take Advantage of TPM</h1>
<p>This section describes:</p>
<ul>
<li>Prerequisites to building the SDK to take advantage of TPM</li>
<li>Building the SDK in TPM mode</li>
<li>Running signing and verification operations with TPM</li>
</ul>
<h2><a class="anchor" id="TpmConsiderations_Prereqs"></a>
Installing Prerequisites</h2>
<ol type="1">
<li>Download Trusted Platform Module Library family 2.0, revision 01.38. The SDK was validated with <a href="https://sourceforge.net/projects/ibmtpm20tss/files/ibmtss1119.tar.gz/download">IBM's TPM2.0 TSS version 1119</a>.</li>
<li>Download Trusted Platform Module family 2.0, revision 01.38. The SDK was validated with <a href="https://sourceforge.net/projects/ibmswtpm2/files/ibmtpm1119.tar.gz/download">IBM's Software TPM2.0 version 1119</a>.</li>
<li>Extract TPM into <code>./ext/ibmtpm1119</code> and TSS into <code>./ext/ibmtss1119</code> and build them in accordance with the build steps from the packages. On Windows, the SDK was only validated with TPM and TSS built in Release configuration targeting Win32 and using OpenSSL version 1.0.2.</li>
</ol>
<h2><a class="anchor" id="TpmConsiderations_BuildingTpmMode"></a>
Building the SDK in TPM Mode</h2>
<p>When building SDK to use TPM set TSSROOT138 environment variable pointing to the <code>&lt;TSS&gt;/utils</code>.</p>
<p>If you are on Windows additionally copy desired versions of <code>tss.lib</code> and <code>tss.dll</code> into <code>&lt;TSS&gt;\utils</code>: </p><pre class="fragment">&gt; copy ext\ibmtss1119\tpmutils\Release\tss.lib ext\ibmtss1119\utils\
&gt; copy ext\ibmtss1119\tpmutils\Release\tss.dll ext\ibmtss1119\utils\
</pre><p>To build the SDK in TPM mode use <code>--use-tss</code> flag.</p>
<p>If you are building on Windows: </p><pre class="fragment">&gt; set TSSROOT138=%CD%\ext\ibmtss1119\utils\
&gt; scons --target=x86 --use-tss
</pre><p>If you are building on Linux: </p><pre class="fragment">$ export TSSROOT138=$PWD/ext/ibmtss1119/utils
$ scons --use-tss
</pre><p>To build the SDK in TPM mode with <code>make</code> use <code>--with-tss</code> flag: </p><pre class="fragment">$ export TSSROOT138=$PWD/ext/ibmtss1119/utils
$ ./configure --with-tss
$ make all
$ make utest
$ make install
</pre><h2><a class="anchor" id="TpmConsiderations_Signing"></a>
Intel® EPID Signing and Verification with a TPM</h2>
<p>Before running SDK samples on Windows you must add the location of OpenSSL DLLs to the PATH environment variable. Assuming OpenSSL is installed in the default location: </p><pre class="fragment">&gt; set PATH="C:\Program Files\OpenSSL\bin";%PATH%
</pre><p>Run the IBM's TPM server in the background, do powerup and startup.</p>
<p>If you are running on Windows: </p><pre class="fragment">&gt; start ext\ibmtpm1119\tpmvstudio\tpm_server\Release\tpm_server.exe
&gt; ext\ibmtss1119\tpmutils\Release\powerup.exe
&gt; ext\ibmtss1119\tpmutils\Release\startup.exe
</pre><p>If you are running on Linux, add TSSROOT138 to LD_LIBRARY_PATH prior to tpm_server powerup: </p><pre class="fragment">$  export LD_LIBRARY_PATH=$TSSROOT138:$LD_LIBRARY_PATH
$ ./ext/ibmtpm1119/src/tpm_server &amp;
$ ./ext/ibmtss1119/utils/powerup
$ ./ext/ibmtss1119/utils/startup
</pre><dl class="section note"><dt>Note</dt><dd>The following sign/verify commands assume <code>_install/data/split</code> is the current directory and that <code>_install/bin</code> is in the path. For a detailed tutorial, refer to <a class="el" href="_sign_verify_tutorial.html">Signing and Verification Tutorial</a>.</dd></dl>
<p>Try signing the message: </p><pre class="fragment">&gt; signmsg --msg="test"
</pre><p>Notice <code>sig.dat</code> file is created. You can verify it running: </p><pre class="fragment">&gt; verifysig --msg="test"
signature verified successfully
</pre><dl class="section warning"><dt>Warning</dt><dd>The samples use <code>LoadExternal</code> to load keys into the TPM. In a real TPM use case, <code>CreatePrimary</code> should be used, and the SDK implementation provides functions for this use case.</dd></dl>
<h1><a class="anchor" id="TpmConsiderations_Notes"></a>
Implementation Notes</h1>
<h2><a class="anchor" id="TpmConsiderations_NVStorage"></a>
NV Storage Specification</h2>
<p>The SDK stores the membership credential to a NV storage area of the TPM reserved for this purpose.</p>
<ul>
<li>The Membership Credential SHALL be identified by the handle <code>0x01C10120</code>.</li>
<li>The index type SHALL be defined as an ordinary index.</li>
<li>NV Index attributes <code>TPMA_NV_AUTHWRITE</code>, <code>TPMA_NV_POLICYWRITE</code>, <code>TPMA_NV_OWNERWRITE</code>, <code>TPMA_NV_POLICY_DELETE</code>, <code>TPMA_NV_GLOBALLOCK</code>, <code>TPMA_NV_ORDERLY</code>, <code>TPMA_NV_CLEAR_STCLEAR</code>, and <code>TPMA_NV_READ_STCLEAR</code> SHALL be <code>CLEAR</code></li>
<li>NV Index attributes <code>TPMA_NV_PLATFORMCREATE</code>, <code>TPMA_NV_AUTHREAD</code>, <code>TPMA_NV_NO_DA</code>, and <code>TPMA_NV_PPWRITE</code> SHALL be <code>SET</code>.</li>
<li>All other NV Index attributes MAY be <code>SET</code></li>
<li>The authorization value for the Membership Credential SHALL be a NULL Auth as defined in the <em>TPM 2.0 Library Specification, Part 1, Terms and definitions</em>.</li>
<li>The authorization policy for the Membership Credential index SHALL be an Empty Buffer as defined in the <em>TPM 2.0 Library Specification, Part 1, Terms and definitions</em>.</li>
<li>The hash algorithm used for the Membership Credential signature SHOULD be <code>TPM_ALG_SHA256</code> with a digest size of 256 bits. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.10-->
<!-- start footer part -->
<div id="nav-path" class="navpath">
    <!-- id is needed for treeview function! -->
    <ul>
        <li class="footer">
            &copy; 2016-2018 Intel Corporation
        </li>
    </ul>
</div>
</body>
</html>
